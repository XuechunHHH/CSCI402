# **ç¬¬äºŒç« ï¼šå¤šçº¿ç¨‹**

## **å¤šçº¿ç¨‹ä»‹ç»**  

### **ä¸ºä»€ä¹ˆéœ€è¦å¹¶å‘ï¼ˆConcurrencyï¼‰ï¼Ÿ**  
ç°ä»£è®¡ç®—æœºç³»ç»Ÿéœ€è¦ **åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡**ï¼š  
âœ… **å¤šä¸ªè¿è¡Œçš„ç¨‹åº** â†’ æ“ä½œç³»ç»Ÿå¿…é¡»åœ¨ç¨‹åºé—´åˆ†é… CPU æ—¶é—´ã€‚  
âœ… **è¾“å…¥/è¾“å‡ºæ“ä½œ** â†’ éœ€è¦å¤„ç† **ç£ç›˜ã€ç½‘ç»œã€é”®ç›˜ç­‰äº‹ä»¶**ã€‚  
âœ… **é«˜æ•ˆåˆ©ç”¨èµ„æº** â†’ é¿å… CPU ç­‰å¾… I/O è€Œç©ºé—²ã€‚  

å³ä½¿ **åªæœ‰ä¸€ä¸ªå¤„ç†å™¨**ï¼Œæ“ä½œç³»ç»Ÿä¹Ÿä¼š **å¿«é€Ÿåˆ‡æ¢ä»»åŠ¡**ï¼Œåˆ¶é€ å‡º **åŒæ—¶è¿è¡Œçš„å‡è±¡**ï¼ˆ**æ—¶é—´ç‰‡è½®è½¬**ï¼‰ã€‚  

---

### **æœ¬ç« å°†æ¶µç›–ä»€ä¹ˆï¼Ÿ**  
ğŸ“Œ **å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€** â†’ å¦‚ä½•ç¼–å†™å¹¶å‘ç¨‹åºã€‚  
ğŸ“Œ **POSIX çº¿ç¨‹ï¼ˆPthreadsï¼‰å’Œ Windows çº¿ç¨‹ï¼ˆWin32ï¼‰** â†’ C/C++ å¤šçº¿ç¨‹ç¼–ç¨‹æ ‡å‡†ã€‚  
ğŸ“Œ **çº¿ç¨‹åŒæ­¥** â†’ **é˜²æ­¢ç«äº‰æ¡ä»¶**ï¼Œä¿è¯æ­£ç¡®æ€§ã€‚  
ğŸ“Œ **çº¿ç¨‹å–æ¶ˆ** â†’ **å®‰å…¨ç®¡ç† & ç»ˆæ­¢çº¿ç¨‹**ã€‚  
ğŸ“Œ **ä»åº”ç”¨ç¨‹åºè§†è§’å­¦ä¹ ** â†’ å…ˆå­¦ä¹  **ç”¨æˆ·æ€** çº¿ç¨‹ï¼Œå†ç†è§£ **æ“ä½œç³»ç»Ÿå†…æ ¸** çš„çº¿ç¨‹ç®¡ç†ã€‚  

è™½ç„¶ **OS å†…éƒ¨çº¿ç¨‹å®ç°ä¸åŒ**ï¼Œä½† **æ ¸å¿ƒæ¦‚å¿µæ˜¯ä¸€æ ·çš„**ï¼ ğŸš€  

---

## **ä¸ºä»€ä¹ˆä½¿ç”¨çº¿ç¨‹ï¼Ÿ**  

### **ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦çº¿ç¨‹ï¼Œè€Œä¸ä»…ä»…æ˜¯è¿›ç¨‹ï¼Ÿ**  
æˆ‘ä»¬å·²ç»åœ¨æ“ä½œç³»ç»Ÿä¸­ä½¿ç”¨ **å¤šä¸ªè¿›ç¨‹**ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦åœ¨**åŒä¸€ä¸ªè¿›ç¨‹å†…éƒ¨ä½¿ç”¨çº¿ç¨‹**ï¼Ÿ  

âœ… **çº¿ç¨‹èƒ½æ›´è‡ªç„¶åœ°å®ç°å¹¶å‘**ã€‚  
âœ… **ä¸ä»…ä»…é€‚ç”¨äºå¤šæ ¸å¤„ç†å™¨**ï¼Œ**å•æ ¸ CPU** ä¹Ÿèƒ½é€šè¿‡çº¿ç¨‹æé«˜ I/O å¤„ç†æ•ˆç‡ã€‚  
âœ… **å¤šçº¿ç¨‹ä»£ç é€šå¸¸æ¯”å•çº¿ç¨‹ä»£ç æ›´ç®€å•ã€æ›´é«˜æ•ˆã€æ›´æ˜“äºè°ƒè¯•**ã€‚  

---

### **ç¤ºä¾‹ 1ï¼šè¿œç¨‹ç™»å½• (`rlogind`)**
**é—®é¢˜ï¼š`rlogind` éœ€è¦åŒæ—¶å¤„ç†ä¸¤ä¸ªè¾“å…¥/è¾“å‡ºæµ**ï¼š  
1. è¯»å– **è¿œç¨‹å®¢æˆ·ç«¯çš„é”®ç›˜è¾“å…¥**ï¼Œå‘é€åˆ°æœåŠ¡å™¨ã€‚  
2. è¯»å– **æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„è¾“å‡º**ï¼Œå‘é€åˆ°è¿œç¨‹å®¢æˆ·ç«¯ã€‚  

ğŸ“Œ **å•çº¿ç¨‹ç‰ˆæœ¬ï¼ˆä»£ç å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤ï¼‰**
```c
void rlogind(int r_in, int r_out, int l_in, int l_out) {
   fd_set in = 0, out;
   int want_l_write = 0, want_r_write = 0;
   int want_l_read = 1, want_r_read = 1;
   int eof = 0, tsize, fsize, wret;
   char fbuf[BSIZE], tbuf[BSIZE];

   fcntl(r_in, F_SETFL, O_NONBLOCK);
   fcntl(r_out, F_SETFL, O_NONBLOCK);
   fcntl(l_in, F_SETFL, O_NONBLOCK);
   fcntl(l_out, F_SETFL, O_NONBLOCK);

   while(!eof) {
      FD_ZERO(&in);
      FD_ZERO(&out);
      if (want_l_read) FD_SET(l_in, &in);
      if (want_r_read) FD_SET(r_in, &in);
      if (want_l_write) FD_SET(l_out, &out);
      if (want_r_write) FD_SET(r_out, &out);

      select(MAXFD, &in, &out, 0, 0);
      if (FD_ISSET(l_in, &in)) {
         if ((tsize = read(l_in, tbuf, BSIZE)) > 0) {
            want_l_read = 0;
            want_r_write = 1;
         } else eof = 1;
      }
      if (FD_ISSET(r_in, &in)) {
         if ((fsize = read(r_in, fbuf, BSIZE)) > 0) {
            want_r_read = 0;
            want_l_write = 1;
         } else eof = 1;
      }
      if (FD_ISSET(l_out, &out)) {
         if ((wret = write(l_out, fbuf, fsize)) == fsize) {
            want_r_read = 1;
            want_l_write = 0;
         } else if (wret >= 0) tsize -= wret;
         else eof = 1;
      }
      if (FD_ISSET(r_out, &out)) {
         if ((wret = write(r_out, tbuf, tsize)) == tsize) {
            want_l_read = 1;
            want_r_write = 0;
         } else if (wret >= 0) tsize -= wret;
         else eof = 1;
      }
   }
}
```
âŒ **éš¾ä»¥é˜…è¯»**  
âŒ **éœ€è¦å¤æ‚çš„éé˜»å¡ I/O**  
âŒ **è°ƒè¯•å›°éš¾**  

ğŸ“Œ **ä½¿ç”¨çº¿ç¨‹çš„ç‰ˆæœ¬ï¼ˆæ›´æ¸…æ™°çš„é€»è¾‘ï¼‰**
```c
void incoming(int r_in, int l_out) {           
   int eof = 0;
   char buf[BSIZE];
   int size;

   while (!eof) {                                
      size = read(r_in, buf, BSIZE);
      if (size <= 0) eof = 1;  
      if (write(l_out, buf, size) <= 0) eof = 1;
   }                                             
}                                                

void outgoing(int l_in, int r_out) {           
   int eof = 0;
   char buf[BSIZE];
   int size;

   while (!eof) {                                
      size = read(l_in, buf, BSIZE);
      if (size <= 0) eof = 1;  
      if (write(r_out, buf, size) <= 0) eof = 1;
   }                                             
}
```
âœ… **ä»£ç æ›´ç®€æ´**  
âœ… **I/O é€»è¾‘æ›´ç®€å•**  
âœ… **æ›´å®¹æ˜“è°ƒè¯•å’Œç»´æŠ¤**  

---

### **ç¤ºä¾‹ 2ï¼šå¤šçº¿ç¨‹æ•°æ®åº“æœåŠ¡å™¨**  
- **å•çº¿ç¨‹æ•°æ®åº“** åªèƒ½ **é€ä¸ª** å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€‚  
- **é—®é¢˜**ï¼šæœ‰äº›è¯·æ±‚å¾ˆå¿«å®Œæˆï¼Œæœ‰äº›è¯·æ±‚éœ€è¦å¾ˆé•¿æ—¶é—´ã€‚  

ğŸ“Œ **å•çº¿ç¨‹è§£å†³æ–¹æ¡ˆ**  
- **è½®æµå¤„ç†æ¯ä¸ªè¯·æ±‚**ï¼ˆä¾‹å¦‚ï¼Œæ¯ä¸ªè¯·æ±‚ 1 æ¯«ç§’ï¼‰ã€‚  
- ä½† **é•¿è¯·æ±‚ä»ç„¶ä¼šå½±å“çŸ­è¯·æ±‚çš„å¤„ç†**ã€‚  

ğŸ“Œ **å¤šçº¿ç¨‹è§£å†³æ–¹æ¡ˆ**  
- **æ¯ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹**ã€‚  
- **é•¿çŸ­è¯·æ±‚å¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œä¸äº’ç›¸å½±å“**ã€‚  
- **åœ¨å¤šæ ¸ CPU ä¸Šï¼Œçº¿ç¨‹å¯ä»¥çœŸæ­£å¹¶è¡Œè¿è¡Œ**ã€‚  

---

### **æ€»ç»“**
âœ… **å¤šçº¿ç¨‹èƒ½è®©å¹¶å‘ç¼–ç¨‹æ›´ç®€å•ã€æ›´é«˜æ•ˆ**ã€‚  
âœ… **çº¿ç¨‹ä¸ä»…é€‚ç”¨äºå¤šæ ¸ CPUï¼Œå•æ ¸ CPU ä¹Ÿèƒ½é€šè¿‡æ›´å¥½çš„ I/O å¤„ç†è·ç›Š**ã€‚  
âœ… **ç›¸æ¯”äºå•çº¿ç¨‹ä»£ç ï¼Œå¤šçº¿ç¨‹ç¨‹åºæ›´å®¹æ˜“ç¼–å†™ã€è°ƒè¯•å’Œç»´æŠ¤**ã€‚ ğŸš€  

---

## **ä½¿ç”¨çº¿ç¨‹ç¼–ç¨‹**  

### **ä¸ºä»€ä¹ˆéœ€è¦æ ‡å‡†çš„çº¿ç¨‹ APIï¼Ÿ**  
å°½ç®¡ **å¤šçº¿ç¨‹æœ‰å¾ˆå¤šä¼˜åŠ¿**ï¼Œä½† **æ ‡å‡† API ç›´åˆ°æœ€è¿‘æ‰è¢«å¼€å‘**ï¼š  
- **POSIX çº¿ç¨‹ï¼ˆPthreadsï¼‰** â†’ åœ¨ **1995 å¹´** æ ‡å‡†åŒ–ï¼Œç¼–å· **POSIX 1003.1c**ã€‚  
- **Windows çº¿ç¨‹ï¼ˆWin32 Threadsï¼‰** â†’ å¾®è½¯ **ä¸“é—¨ä¸º Windows å¼€å‘**ã€‚  

ğŸ“Œ **ä¸¤è€…çš„ä¸»è¦åŒºåˆ«**ï¼š  
âœ… **æ¥å£ä¸åŒ** â†’ **å‡½æ•°è°ƒç”¨å’Œè¯­æ³•** éœ€è¦é€‚é…ä¸åŒ APIã€‚  
âœ… **èƒ½åŠ›ä¸åŒ** â†’ **æŸäº›åŠŸèƒ½** åœ¨ **Pthreads å’Œ Win32 ä¹‹é—´ä¸å…¼å®¹**ã€‚  

å°½ç®¡ **Pthreads å’Œ Win32 çº¿ç¨‹æœ‰ä¸åŒå®ç°æ–¹å¼**ï¼Œä½† **ä¸¤è€…éƒ½å¯ä»¥é«˜æ•ˆæ”¯æŒå¤šçº¿ç¨‹ç¼–ç¨‹**ã€‚  

---


## **POSIXï¼ˆPthreadsï¼‰çº¿ç¨‹çš„åˆ›å»ºå’Œç»ˆæ­¢**  

### **åœ¨ POSIXï¼ˆPthreadsï¼‰ä¸­åˆ›å»ºçº¿ç¨‹**  
åœ¨ **Unix ç³»ç»Ÿ** ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `pthread_create()` æ¥åˆ›å»ºçº¿ç¨‹ã€‚  
âœ… **åˆ›å»ºæ–°çº¿ç¨‹**ï¼Œæ‰§è¡Œä¸€ä¸ªå‡½æ•°ã€‚  
âœ… **å‘çº¿ç¨‹ä¼ é€’å‚æ•°**ã€‚  
âœ… **å­˜å‚¨çº¿ç¨‹ ID** åœ¨ `pthread_t` å˜é‡ä¸­ã€‚  

### **POSIX çº¿ç¨‹åˆ›å»ºç¤ºä¾‹**  

```c
#include <pthread.h>  
#include <stdio.h>  
#include <stdlib.h>  

#define NUM_THREADS 5  

void *server(void *arg) {
    int thread_id = *(int *)arg;
    printf("æœåŠ¡å™¨çº¿ç¨‹ %d å¯åŠ¨ã€‚\n", thread_id);
    return NULL;
}

void start_servers() {
    pthread_t thread[NUM_THREADS];
    int i, args[NUM_THREADS];

    for (i = 0; i < NUM_THREADS; i++) {
        args[i] = i;
        if (pthread_create(&thread[i], NULL, server, &args[i]) != 0) {
            perror("pthread_create å¤±è´¥");
            exit(1);
        }
    }

    for (i = 0; i < NUM_THREADS; i++) {
        pthread_join(thread[i], NULL);
    }
}

int main() {
    start_servers();
    return 0;
}
```

ğŸ“Œ **è§£é‡Š:**  
- `pthread_create(&thread[i], NULL, server, &args[i]);` â†’ åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶æ‰§è¡Œ `server()`ã€‚  
- `pthread_join(thread[i], NULL);` â†’ ç­‰å¾…çº¿ç¨‹å®Œæˆã€‚  
- æ¯ä¸ªçº¿ç¨‹ **æ‰“å°è‡ªå·±çš„ ID**ï¼Œç„¶åé€€å‡ºã€‚  

---

### **å¦‚ä½•å‘çº¿ç¨‹ä¼ é€’å¤šä¸ªå‚æ•°**  
`pthread_create()` åªèƒ½æ¥å— **ä¸€ä¸ªå‚æ•°**ï¼Œä½†å¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦ä¼ é€’å¤šä¸ªå‚æ•°ã€‚  

âŒ **é”™è¯¯æ–¹æ³•ï¼šç›´æ¥ä¼ é€’å±€éƒ¨å˜é‡åœ°å€**  
```c
int arg = 5;
pthread_create(&thread, NULL, my_thread_function, &arg);
```
è¿™é‡Œ `arg` å¯èƒ½åœ¨ **çº¿ç¨‹è¿è¡Œå‰è¢«é‡Šæ”¾**ï¼Œå¯¼è‡´ **æœªå®šä¹‰è¡Œä¸º**ã€‚  

âœ… **æ­£ç¡®æ–¹æ³•ï¼šä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜**  
```c
void *thread_func(void *arg) {
    int *val = (int *)arg;
    printf("çº¿ç¨‹æ¥æ”¶åˆ°ï¼š%d\n", *val);
    free(arg);
    return NULL;
}

void create_thread() {
    pthread_t thread;
    int *arg = malloc(sizeof(int));
    *arg = 5;
    pthread_create(&thread, NULL, thread_func, arg);
    pthread_join(thread, NULL);
}
```
ğŸ“Œ **è§£é‡Šï¼š**  
- ä½¿ç”¨ `malloc()` åˆ†é…å‚æ•°ï¼Œä½¿å…¶åœ¨ **çº¿ç¨‹è¿è¡ŒæœŸé—´ä¸ä¼šè¢«é‡Šæ”¾**ã€‚  
- çº¿ç¨‹ç»“æŸæ—¶ï¼Œä½¿ç”¨ `free(arg);` **é‡Šæ”¾å†…å­˜**ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚  

---

### **çº¿ç¨‹çš„ç»ˆæ­¢æ–¹å¼**  
çº¿ç¨‹æœ‰ä¸¤ç§ç»ˆæ­¢æ–¹å¼ï¼š  
1. **è¿”å›ä¸€ä¸ªå€¼** â†’ `return (void *) value;`  
2. **è°ƒç”¨ `pthread_exit(value);`**  

ç¤ºä¾‹ä»£ç ï¼š  
```c
void *thread_func(void *arg) {
    int thread_id = *(int *)arg;
    pthread_exit((void *)(thread_id * 10));
}

int main() {
    pthread_t thread;
    int arg = 5;
    void *ret_val;

    pthread_create(&thread, NULL, thread_func, &arg);
    pthread_join(thread, &ret_val);

    printf("çº¿ç¨‹è¿”å›å€¼ï¼š%ld\n", (long)ret_val);
    return 0;
}
```
ğŸ“Œ **è§£é‡Š:**  
- çº¿ç¨‹è¿”å› `thread_id * 10`ï¼Œç”± `pthread_join()` **è·å–è¿”å›å€¼**ã€‚  

---

### **åˆ†ç¦»çº¿ç¨‹ï¼ˆé¿å…åƒµå°¸çº¿ç¨‹ï¼‰**  
- é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ç»ˆæ­¢åä¼šè¿›å…¥ **"åƒµå°¸çŠ¶æ€"**ï¼Œç›´åˆ° `pthread_join()` **å›æ”¶èµ„æº**ã€‚  
- è‹¥ä¸éœ€è¦ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œå¯ä»¥ä½¿ç”¨ `pthread_detach()`ï¼š  

```c
pthread_t thread;
pthread_create(&thread, NULL, thread_func, NULL);
pthread_detach(thread);
```
- **åˆ†ç¦»çš„çº¿ç¨‹** åœ¨ç»“æŸæ—¶ **è‡ªåŠ¨é‡Šæ”¾èµ„æº**ï¼Œä¸éœ€è¦ `pthread_join()`ã€‚  

---

## **Summary æ€»ç»“**  
âœ… `pthread_create()` â†’ åˆ›å»ºçº¿ç¨‹ã€‚  
âœ… `pthread_exit()` â†’ çº¿ç¨‹ä¸»åŠ¨ç»ˆæ­¢ã€‚  
âœ… `pthread_join()` â†’ ç­‰å¾…çº¿ç¨‹ç»“æŸå¹¶è·å–è¿”å›å€¼ã€‚  
âœ… `pthread_detach()` â†’ ä½¿çº¿ç¨‹ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€å›æ”¶èµ„æºã€‚  

---

## **C++ çº¿ç¨‹ (Pthreads)**  

### **å°† C++ å¯¹è±¡ä¸çº¿ç¨‹ç»“åˆ**  
POSIX çº¿ç¨‹ (`pthreads`) å¹¶ä¸æ˜¯ C++ è¯­è¨€çš„å†…ç½®åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸€ä¸ª**åº“å‡½æ•°**ã€‚ä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **C++ çš„é¢å‘å¯¹è±¡ç‰¹æ€§** æ¥ç»„ç»‡å¤šçº¿ç¨‹ä»£ç ï¼Œä½¿å…¶æ›´æ¸…æ™°ã€å¯ç»´æŠ¤ã€‚  

---

### **C++ çº¿ç¨‹ç±»çš„åŸºæœ¬å®ç°**  
æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç±»ï¼Œæ¯æ¬¡ **åˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹**ã€‚  

ç¤ºä¾‹ï¼š  
```cpp
#include <pthread.h>  
#include <iostream>  

class Server {
public:
   Server(int in, int out) : in_(in), out_(out) {
      pthread_create(&thread_, NULL, start, (void*)this);
   }
private:
   int in_, out_;
   static void *start(void *arg);
   pthread_t thread_;
};

void *Server::start(void *arg) {
   Server* me = (Server*) arg;
   std::cout << "æœåŠ¡å™¨çº¿ç¨‹å¤„ç†è¾“å…¥ï¼š" << me->in_ << "\n";
   return NULL;
}

int main() {
   Server s1(1, 2);
   pthread_exit(NULL);
}
```
ğŸ“Œ **è§£é‡Š:**  
- `pthread_create()` åœ¨ `Server` **æ„é€ å‡½æ•°** ä¸­è°ƒç”¨ï¼Œè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹ã€‚  
- `start()` **å¿…é¡»æ˜¯é™æ€å‡½æ•°**ï¼Œå¦åˆ™ `pthread_create()` ä¸èƒ½æ­£ç¡®è°ƒç”¨å®ƒã€‚  
- **ä½¿ç”¨ `this` ä¼ é€’å¯¹è±¡åœ°å€**ï¼Œçº¿ç¨‹æ‰èƒ½è®¿é—®æˆå‘˜å˜é‡ã€‚  

---

### **çº¿ç¨‹çš„ç»ˆæ­¢æ–¹æ³•**  

#### **æ–¹æ³• 1: çº¿ç¨‹è‡ªè¡Œåˆ é™¤å¯¹è±¡**  
```cpp
class Server {
public:
  Server(int in, int out): in_(in), out_(out) {
    pthread_create(&thread_, NULL, start, (void*)this);
    pthread_detach(thread_);
  }
  ~Server() { }
private:
  int in_, out_;
  static void *start(void *arg);
  pthread_t thread_;
};

void *Server::start(void *arg) {
  Server* me = (Server*) arg;
  std::cout << "æœåŠ¡å™¨çº¿ç¨‹æ­£åœ¨è¿è¡Œ...\n";
  delete me;  // çº¿ç¨‹ç»“æŸæ—¶åˆ é™¤å¯¹è±¡
  return NULL;
}
```
ğŸ“Œ **ä¼˜ç¼ºç‚¹:**  
âœ… **è‡ªåŠ¨åˆ é™¤å¯¹è±¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼**ã€‚  
âŒ **ä¸èƒ½ä½¿ç”¨ `pthread_join()`**ï¼Œæ— æ³•è·å–è¿”å›å€¼ã€‚  

---

#### **æ–¹æ³• 2: åœ¨ææ„å‡½æ•°ä¸­ç­‰å¾…çº¿ç¨‹ç»“æŸ**  
```cpp
class Server {
public:
   Server(int in, int out): in_(in), out_(out) {
      pthread_create(&thread_, NULL, start, (void*)this);
   }
   ~Server() {
      pthread_join(thread_, NULL);  // ç¡®ä¿çº¿ç¨‹ç»“æŸ
   }
};
```
ğŸ“Œ **ä¼˜ç¼ºç‚¹:**  
âœ… **ç¡®ä¿çº¿ç¨‹åœ¨å¯¹è±¡é”€æ¯å‰ç»“æŸ**ã€‚  
âŒ **æ— æ³•è¿”å›çº¿ç¨‹çš„ç»“æœ**ã€‚  

---

#### **æ–¹æ³• 3: é€šè¿‡ `join()` å…è®¸çº¿ç¨‹è¿”å›å€¼**  
```cpp
class Server {
public:
   Server(int in, int out): in_(in), out_(out) {
      pthread_create(&thread_, NULL, start, (void*)this);
   }
   int join() {
      int ret;
      pthread_join(thread_, (void**)&ret);
      return ret;
   }
};
```
ğŸ“Œ **ä¼˜ç¼ºç‚¹:**  
âœ… **å…è®¸è·å–çº¿ç¨‹çš„è¿”å›å€¼**ã€‚  
âŒ **éœ€è¦æ˜¾å¼è°ƒç”¨ `join()` ä»¥é˜²æ­¢å†…å­˜æ³„æ¼**ã€‚  

---

## **æ€»ç»“ Summary**  
âœ… `pthread_create()` â†’ åˆ›å»ºçº¿ç¨‹ã€‚  
âœ… `pthread_detach()` â†’ è®©çº¿ç¨‹è‡ªåŠ¨å›æ”¶èµ„æºã€‚  
âœ… `pthread_join()` â†’ ç­‰å¾…çº¿ç¨‹ç»“æŸå¹¶è·å–è¿”å›å€¼ã€‚  
âœ… **C++ çº¿ç¨‹ç±»** éœ€è¦ **ç‰¹æ®Šå¤„ç†å¯¹è±¡é”€æ¯ä¸çº¿ç¨‹ç»“æŸçš„å…³ç³»**ã€‚  

---

## **å¤šçº¿ç¨‹åŒæ­¥**  

### **ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥ï¼Ÿ**  
åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¯èƒ½**åŒæ—¶è®¿é—®å…±äº«æ•°æ®**ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®çš„åŒæ­¥æœºåˆ¶ï¼Œå°±ä¼šå‡ºç° **æ•°æ®ç«äº‰ï¼ˆRace Conditionï¼‰**ï¼Œå¯¼è‡´ **æ•°æ®æŸå** æˆ– **æœªå®šä¹‰è¡Œä¸º**ã€‚  

âœ… **åŒæ­¥çš„ä½œç”¨ï¼š**  
1. **äº’æ–¥ï¼ˆMutexï¼‰** â†’ ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚  
2. **çº¿ç¨‹é€šä¿¡ï¼ˆæ¡ä»¶å˜é‡ï¼‰** â†’ å…è®¸çº¿ç¨‹ç›¸äº’é€šçŸ¥æ‰§è¡Œé¡ºåºã€‚  

---

### **äº’æ–¥é”ï¼ˆMutexï¼‰**  
**`pthread_mutex_t`** ç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰**ä¸€ä¸ªçº¿ç¨‹**å¯ä»¥è®¿é—®**å…³é”®åŒºåŸŸï¼ˆcritical sectionï¼‰**ã€‚  

#### **POSIX äº’æ–¥é”ç¤ºä¾‹**
```cpp
#include <pthread.h>
#include <stdio.h>

pthread_mutex_t lock = PTHREAD_MUTEX_INITIALIZER;
int shared_counter = 0;

void *increment(void *arg) {
    for (int i = 0; i < 1000000; i++) {
        pthread_mutex_lock(&lock);
        shared_counter++;
        pthread_mutex_unlock(&lock);
    }
    return NULL;
}
```
ğŸ“Œ **å…³é”®ç‚¹ï¼š**  
- `pthread_mutex_lock()` åŠ é”ï¼Œä¿è¯ **åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ä¿®æ”¹æ•°æ®**ã€‚  
- `pthread_mutex_unlock()` é‡Šæ”¾é”ï¼Œè®©å…¶ä»–çº¿ç¨‹è¿›å…¥å…³é”®åŒºåŸŸã€‚  

---

### **æ­»é”ï¼ˆDeadlockï¼‰**
**æ­»é”** å‘ç”Ÿåœ¨ä¸¤ä¸ªçº¿ç¨‹**ç›¸äº’ç­‰å¾…å¯¹æ–¹é‡Šæ”¾èµ„æº**ï¼Œå¯¼è‡´ç¨‹åºå¡æ­»ã€‚  

```cpp
pthread_mutex_t lock1, lock2;
void *task1(void *arg) {
    pthread_mutex_lock(&lock1);
    pthread_mutex_lock(&lock2);  // æ­»é”ç­‰å¾…
    pthread_mutex_unlock(&lock2);
    pthread_mutex_unlock(&lock1);
}
```
ğŸ“Œ **é¿å…æ­»é”çš„æ–¹æ³•ï¼š**  
âœ… **ä¿è¯æ‰€æœ‰çº¿ç¨‹æŒ‰ç›¸åŒé¡ºåºåŠ é”**ï¼ˆæ¯”å¦‚ `lock1` â†’ `lock2`ï¼‰ã€‚  

---

## **æ€»ç»“ Summary**  
âœ… `pthread_mutex_t` â†’ äº’æ–¥é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨è®¿é—®æ•°æ®ã€‚  
âœ… `pthread_cond_t` â†’ çº¿ç¨‹é€šä¿¡ï¼Œé€šçŸ¥æŸä¸ªçº¿ç¨‹æ‰§è¡Œã€‚  

---

## **è¶…è¶Šäº’æ–¥é”ï¼šæ›´å¤æ‚çš„çº¿ç¨‹åŒæ­¥é—®é¢˜**

### **1. äº’æ–¥é”çš„å±€é™æ€§**
äº’æ–¥é”ï¼ˆmutexï¼‰èƒ½ç¡®ä¿**ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹**è®¿é—®å…±äº«èµ„æºï¼Œä½†å®ƒè¿‡äºä¸¥æ ¼ï¼Œæ— æ³•è§£å†³æ‰€æœ‰åŒæ­¥é—®é¢˜ã€‚ä¾‹å¦‚ï¼š

- **é—®é¢˜ 1ï¼šè¯»è€…-å†™è€…é—®é¢˜ï¼ˆReaders-Writers Problemï¼‰**  
  - **å¤šä¸ªè¯»è€…ï¼ˆReadersï¼‰**åŒæ—¶è¯»å–æ•°æ®æ—¶ï¼Œå®ƒä»¬å¹¶ä¸ä¼šå½±å“æ•°æ®çš„å®Œæ•´æ€§ï¼Œå› æ­¤åº”è¯¥å…è®¸å¤šä¸ªè¯»è€…**åŒæ—¶**è®¿é—®èµ„æºã€‚  
  - ä½†**å†™è€…ï¼ˆWriterï¼‰**ä¿®æ”¹æ•°æ®æ—¶ï¼Œéœ€è¦**ç‹¬å è®¿é—®æƒé™**ï¼Œä¸èƒ½è®©è¯»è€…æˆ–å…¶ä»–å†™è€…åŒæ—¶æ“ä½œæ•°æ®ã€‚  
  - äº’æ–¥é”ä¸èƒ½åŒºåˆ†**è¯»**å’Œ**å†™**ï¼Œä¼šè®©æ‰€æœ‰è®¿é—®å˜å¾—ä¸²è¡Œï¼Œæ•ˆç‡ä½ä¸‹ã€‚

- **é—®é¢˜ 2ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼ˆProducer-Consumer Problemï¼‰**  
  - **ç”Ÿäº§è€…**å°†æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œ**æ¶ˆè´¹è€…**ä»ç¼“å†²åŒºå–å‡ºæ•°æ®ã€‚  
  - å¦‚æœ**ç¼“å†²åŒºå·²æ»¡**ï¼Œç”Ÿäº§è€…å¿…é¡»**ç­‰å¾…**æ¶ˆè´¹è€…å–èµ°æ•°æ®ã€‚  
  - å¦‚æœ**ç¼“å†²åŒºä¸ºç©º**ï¼Œæ¶ˆè´¹è€…å¿…é¡»**ç­‰å¾…**ç”Ÿäº§è€…æ”¾å…¥æ–°æ•°æ®ã€‚  
  - äº’æ–¥é”ä¸èƒ½è§£å†³è¿™ç§**ç­‰å¾…**å’Œ**é€šçŸ¥**çš„é—®é¢˜ã€‚

- **é—®é¢˜ 3ï¼šäº‹ä»¶åŒæ­¥é—®é¢˜ï¼ˆEvent Synchronizationï¼‰**  
  - çº¿ç¨‹éœ€è¦ç­‰å¾…æŸä¸ª**äº‹ä»¶ï¼ˆEventï¼‰**å‘ç”Ÿï¼Œä¾‹å¦‚ç­‰å¾…**ç£ç›˜è¯»å–å®Œæˆ**ï¼Œç„¶åæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹éƒ½å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚  
  - äº’æ–¥é”åªèƒ½æ§åˆ¶**è®¿é—®é¡ºåº**ï¼Œä½†æ— æ³•**é€šçŸ¥å¤šä¸ªçº¿ç¨‹**ï¼Œæ— æ³•å¤„ç†è¿™ç§åŒæ­¥éœ€æ±‚ã€‚

ğŸ‘‰ **ä¸ºäº†å¤„ç†è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦**ä¿¡å·é‡ï¼ˆSemaphoresï¼‰å’Œ**æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰**ã€‚

---

## **2. ä¿¡å·é‡ï¼ˆSemaphoreï¼‰**
ä¿¡å·é‡æ˜¯ä¸€ä¸ª**éè´Ÿæ•´æ•°**ï¼Œå®ƒæ”¯æŒä¸¤ç§æ“ä½œï¼š
- **P æ“ä½œï¼ˆç­‰å¾…ï¼ŒWaitï¼‰ï¼š**  
  - å¦‚æœä¿¡å·é‡çš„å€¼å¤§äº 0ï¼Œæ‰§è¡Œ `semaphore--`ï¼Œç„¶åç»§ç»­æ‰§è¡Œã€‚  
  - å¦‚æœä¿¡å·é‡çš„å€¼æ˜¯ 0ï¼Œçº¿ç¨‹å¿…é¡»**ç­‰å¾…**ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹å¢åŠ ä¿¡å·é‡çš„å€¼ã€‚  
- **V æ“ä½œï¼ˆä¿¡å·ï¼ŒSignalï¼‰ï¼š**  
  - çº¿ç¨‹æ‰§è¡Œ `semaphore++`ï¼Œé€šçŸ¥å…¶ä»–ç­‰å¾…çš„çº¿ç¨‹å®ƒå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

---

### **2.1 ç”¨ä¿¡å·é‡å®ç°äº’æ–¥é”**
æˆ‘ä»¬å¯ä»¥ç”¨**äºŒå…ƒä¿¡å·é‡**ï¼ˆå€¼ä¸º 0 æˆ– 1ï¼‰æ¥å®ç°äº’æ–¥é”ï¼š

```cpp
#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>

sem_t semaphore; // å®šä¹‰ä¿¡å·é‡

void *task(void *arg) {
    sem_wait(&semaphore);  // P æ“ä½œï¼ˆé”å®šèµ„æºï¼‰
    printf("çº¿ç¨‹ %ld æ­£åœ¨æ‰§è¡Œ\n", (long)arg);
    sleep(1);
    sem_post(&semaphore);  // V æ“ä½œï¼ˆé‡Šæ”¾èµ„æºï¼‰
    return NULL;
}

int main() {
    pthread_t threads[3];
    sem_init(&semaphore, 0, 1);  // åˆå§‹åŒ–ä¿¡å·é‡ä¸º 1ï¼ˆç±»ä¼¼äº’æ–¥é”ï¼‰

    for (long i = 0; i < 3; i++)
        pthread_create(&threads[i], NULL, task, (void *)i);

    for (int i = 0; i < 3; i++)
        pthread_join(threads[i], NULL);

    sem_destroy(&semaphore);
    return 0;
}
```
ğŸ“Œ **è§£é‡Šï¼š**  
- `sem_wait(&semaphore)` **é”å®šä¿¡å·é‡**ï¼Œè®©å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…ã€‚  
- `sem_post(&semaphore)` **é‡Šæ”¾ä¿¡å·é‡**ï¼Œè®©ä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚  

---

### **2.2 ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**
åœ¨**ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
- **`empty` ä¿¡å·é‡** â†’ è®°å½•ç¼“å†²åŒºä¸­å¯ç”¨çš„ç©ºä½ã€‚  
- **`full` ä¿¡å·é‡** â†’ è®°å½•ç¼“å†²åŒºä¸­å·²ç»å¡«æ»¡çš„æ•°æ®ã€‚  
- **äº’æ–¥é” `pthread_mutex_t`** â†’ ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ç¼“å†²åŒºã€‚  

```cpp
#include <stdio.h>
#include <pthread.h>
#include <semaphore.h>

#define BUFFER_SIZE 5
int buffer[BUFFER_SIZE];
int in = 0, out = 0;

sem_t empty, full;
pthread_mutex_t mutex;

void *producer(void *arg) {
    for (int i = 0; i < 10; i++) {
        sem_wait(&empty);    // ç­‰å¾…æœ‰ç©ºä½
        pthread_mutex_lock(&mutex);

        buffer[in] = i;      // ç”Ÿäº§æ•°æ®
        printf("ç”Ÿäº§ï¼š%d\n", i);
        in = (in + 1) % BUFFER_SIZE;

        pthread_mutex_unlock(&mutex);
        sem_post(&full);     // å¢åŠ å·²å¡«å……çš„æ•°é‡
        sleep(1);
    }
    return NULL;
}

void *consumer(void *arg) {
    for (int i = 0; i < 10; i++) {
        sem_wait(&full);     // ç­‰å¾…æ•°æ®å¯ç”¨
        pthread_mutex_lock(&mutex);

        int item = buffer[out];  // æ¶ˆè´¹æ•°æ®
        printf("æ¶ˆè´¹ï¼š%d\n", item);
        out = (out + 1) % BUFFER_SIZE;

        pthread_mutex_unlock(&mutex);
        sem_post(&empty);    // å¢åŠ ç©ºä½
        sleep(2);
    }
    return NULL;
}

int main() {
    pthread_t prod, cons;
    sem_init(&empty, 0, BUFFER_SIZE);
    sem_init(&full, 0, 0);
    pthread_mutex_init(&mutex, NULL);

    pthread_create(&prod, NULL, producer, NULL);
    pthread_create(&cons, NULL, consumer, NULL);

    pthread_join(prod, NULL);
    pthread_join(cons, NULL);

    sem_destroy(&empty);
    sem_destroy(&full);
    pthread_mutex_destroy(&mutex);
    return 0;
}
```
ğŸ“Œ **è§£é‡Šï¼š**  
- **ç”Ÿäº§è€…ç­‰å¾…ç¼“å†²åŒºæœ‰ç©ºä½ï¼Œæ¶ˆè´¹è€…ç­‰å¾…æœ‰æ•°æ®å¯ç”¨ã€‚**  
- é€šè¿‡ `sem_wait()` å’Œ `sem_post()` **ä¿è¯æ­£ç¡®çš„æ‰§è¡Œé¡ºåºã€‚**  

---

## **3. æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰**
æ¡ä»¶å˜é‡å…è®¸**çº¿ç¨‹ç­‰å¾…æŸä¸ªç‰¹å®šçš„æ¡ä»¶å˜ä¸ºçœŸ**ã€‚

### **3.1 è¯»è€…-å†™è€…é—®é¢˜**
- **å¤šä¸ªè¯»è€…å¯ä»¥åŒæ—¶è¯»æ•°æ®ã€‚**  
- **å†™è€…å¿…é¡»ç‹¬å è®¿é—®æƒé™ã€‚**  

```cpp
#include <pthread.h>
#include <stdio.h>

pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t readerQ = PTHREAD_COND_INITIALIZER;
pthread_cond_t writerQ = PTHREAD_COND_INITIALIZER;
int readers = 0, writers = 0;

void *reader(void *arg) {
    pthread_mutex_lock(&mutex);
    while (writers > 0)   // ç­‰å¾…å†™è€…å®Œæˆ
        pthread_cond_wait(&readerQ, &mutex);
    readers++;
    pthread_mutex_unlock(&mutex);

    printf("è¯»è€… %ld è¯»å–æ•°æ®\n", (long)arg);
    sleep(1);

    pthread_mutex_lock(&mutex);
    readers--;
    if (readers == 0) 
        pthread_cond_signal(&writerQ); // å…è®¸å†™è€…æ‰§è¡Œ
    pthread_mutex_unlock(&mutex);
    return NULL;
}

void *writer(void *arg) {
    pthread_mutex_lock(&mutex);
    while (readers > 0 || writers > 0) // ç­‰å¾…æ‰€æœ‰è¯»è€…å’Œå†™è€…å®Œæˆ
        pthread_cond_wait(&writerQ, &mutex);
    writers++;
    pthread_mutex_unlock(&mutex);

    printf("å†™è€… %ld ä¿®æ”¹æ•°æ®\n", (long)arg);
    sleep(2);

    pthread_mutex_lock(&mutex);
    writers--;
    pthread_cond_broadcast(&readerQ); // å”¤é†’æ‰€æœ‰è¯»è€…
    pthread_cond_signal(&writerQ);    // å…è®¸ä¸‹ä¸€ä¸ªå†™è€…æ‰§è¡Œ
    pthread_mutex_unlock(&mutex);
    return NULL;
}
```
ğŸ“Œ **è§£é‡Šï¼š**  
- `pthread_cond_wait(&readerQ, &mutex)` **ç­‰å¾…å†™è€…å®Œæˆ**ã€‚  
- `pthread_cond_broadcast(&readerQ)` **å”¤é†’æ‰€æœ‰ç­‰å¾…çš„è¯»è€…**ã€‚  
- `pthread_cond_signal(&writerQ)` **å”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çš„å†™è€…**ã€‚  

---

## **æ€»ç»“**
âœ… **ä¿¡å·é‡ï¼ˆSemaphoreï¼‰** â†’ é€‚ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ã€‚  
âœ… **æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰** â†’ é€‚ç”¨äºè¯»è€…-å†™è€…é—®é¢˜ã€‚  
âœ… **ä¸¤è€…éƒ½èƒ½è§£å†³æ›´å¤æ‚çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ï¼** ğŸš€

---

## **å—ä¿æŠ¤å‘½ä»¤ï¼ˆGuarded Commandï¼‰ä¸ POSIX çº¿ç¨‹åŒæ­¥å®ç°**
---

åœ¨**å¤šçº¿ç¨‹åŒæ­¥**ä¸­ï¼Œ**å—ä¿æŠ¤å‘½ä»¤ï¼ˆGuarded Commandï¼‰**æ˜¯ä¸€ç§é€»è¾‘ç»“æ„ï¼Œå®ƒç¡®ä¿**æŸä¸ªæ¡ä»¶ï¼ˆGuardï¼‰æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹æ‰èƒ½æ‰§è¡Œç‰¹å®šä»£ç å—**ã€‚å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œçº¿ç¨‹å¿…é¡»**ç­‰å¾…**ã€‚

POSIX çº¿ç¨‹ï¼ˆ`pthread`ï¼‰çš„**æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰**æä¾›äº†ç±»ä¼¼çš„æœºåˆ¶ï¼Œå…è®¸çº¿ç¨‹**åœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹æ—¶è¿›å…¥ä¼‘çœ **ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹**ä¿®æ”¹æ¡ä»¶å¹¶é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹**ã€‚

---

### **1. å—ä¿æŠ¤å‘½ä»¤çš„æ¦‚å¿µ**
**å—ä¿æŠ¤å‘½ä»¤çš„ç»“æ„**
```cpp
when (guard) [  
    statement 1;  
    ...  
    statement n;  
]

[...]
```
ğŸ“Œ **è§£é‡Šï¼š**  
- `guard`ï¼ˆ**ä¿æŠ¤æ¡ä»¶**ï¼‰ï¼šçº¿ç¨‹åªæœ‰åœ¨ `guard` ä¸ºçœŸæ—¶æ‰å¯ä»¥æ‰§è¡Œ `{ statement 1 ... statement n }`ã€‚  
- å¦‚æœ `guard` **ä¸æ»¡è¶³**ï¼Œçº¿ç¨‹å¿…é¡»**ç­‰å¾…**ï¼Œç›´åˆ° `guard` å˜ä¸º `true`ã€‚

---

### **2. POSIX æ¡ä»¶å˜é‡å®ç°ï¼ˆä¸å—ä¿æŠ¤å‘½ä»¤å¯¹æ¯”ï¼‰**
åœ¨ POSIX çº¿ç¨‹åº“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ **äº’æ–¥é”ï¼ˆMutexï¼‰** å’Œ **æ¡ä»¶å˜é‡ï¼ˆCondition Variableï¼‰** å®ç°å—ä¿æŠ¤å‘½ä»¤ã€‚

#### **2.1 çº¿ç¨‹ç­‰å¾…æ¡ä»¶æˆç«‹**
```cpp
pthread_mutex_lock(&mutex);
while (!guard)   // åªè¦æ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±ç­‰å¾…
    pthread_cond_wait(&cond_var, &mutex);  

statement 1;  
...  
statement n;  

pthread_mutex_unlock(&mutex);
```
ğŸ“Œ **è§£é‡Šï¼š**  
1. **é”ä½äº’æ–¥é‡ `mutex`**ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹ `guard`ã€‚  
2. **å¦‚æœ `guard` ä¸ºå‡**ï¼Œè°ƒç”¨ `pthread_cond_wait(&cond_var, &mutex);` è®©çº¿ç¨‹**è¿›å…¥ç­‰å¾…çŠ¶æ€**ï¼Œç›´åˆ° `guard` è¢«ä¿®æ”¹ã€‚  
3. **ä¸€æ—¦ `guard` ä¸ºçœŸ**ï¼Œçº¿ç¨‹æ¢å¤æ‰§è¡Œï¼Œæ‰§è¡Œ `{ statement 1 ... statement n }`ã€‚  
4. **é‡Šæ”¾äº’æ–¥é‡ `mutex`**ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è®¿é—®èµ„æºã€‚  

---

#### **2.2 ä»£ç ä¿®æ”¹ `guard` å¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹**
```cpp
pthread_mutex_lock(&mutex);  

// ä¿®æ”¹ guard
...

pthread_cond_broadcast(&cond_var); // å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹  
pthread_mutex_unlock(&mutex);
```
ğŸ“Œ **è§£é‡Šï¼š**  
1. çº¿ç¨‹å…ˆ**é”å®š `mutex`**ï¼Œç¡®ä¿å¯¹ `guard` çš„ä¿®æ”¹æ˜¯åŸå­æ“ä½œã€‚  
2. ä¿®æ”¹ `guard` çš„å€¼ï¼Œä½¿å…¶æ»¡è¶³ç­‰å¾…çº¿ç¨‹çš„æ¡ä»¶ã€‚  
3. è°ƒç”¨ `pthread_cond_broadcast(&cond_var);` **å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹**ï¼Œè®©å®ƒä»¬é‡æ–°æ£€æŸ¥ `guard` çš„å€¼ã€‚  
4. **è§£é” `mutex`**ï¼Œè®©å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚  

---

### **3. ä»£ç ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**
å—ä¿æŠ¤å‘½ä»¤çš„å…¸å‹åº”ç”¨æ˜¯**ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**ï¼Œå®ƒéœ€è¦**åœ¨ç¼“å†²åŒºæ»¡/ç©ºæ—¶è®©çº¿ç¨‹ç­‰å¾…**ã€‚

```cpp
#include <stdio.h>
#include <pthread.h>

#define BUFFER_SIZE 5
int buffer[BUFFER_SIZE], count = 0;
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
pthread_cond_t not_full = PTHREAD_COND_INITIALIZER;
pthread_cond_t not_empty = PTHREAD_COND_INITIALIZER;

void *producer(void *arg) {
    for (int i = 0; i < 10; i++) {
        pthread_mutex_lock(&mutex);
        while (count == BUFFER_SIZE)  // å½“ç¼“å†²åŒºæ»¡æ—¶ç­‰å¾…
            pthread_cond_wait(&not_full, &mutex);

        buffer[count++] = i;  // ç”Ÿäº§æ•°æ®
        printf("ç”Ÿäº§ï¼š%d\n", i);

        pthread_cond_signal(&not_empty);  // å”¤é†’æ¶ˆè´¹è€…
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}

void *consumer(void *arg) {
    for (int i = 0; i < 10; i++) {
        pthread_mutex_lock(&mutex);
        while (count == 0)  // å½“ç¼“å†²åŒºä¸ºç©ºæ—¶ç­‰å¾…
            pthread_cond_wait(&not_empty, &mutex);

        int item = buffer[--count];  // æ¶ˆè´¹æ•°æ®
        printf("æ¶ˆè´¹ï¼š%d\n", item);

        pthread_cond_signal(&not_full);  // å”¤é†’ç”Ÿäº§è€…
        pthread_mutex_unlock(&mutex);
    }
    return NULL;
}

int main() {
    pthread_t prod, cons;
    pthread_create(&prod, NULL, producer, NULL);
    pthread_create(&cons, NULL, consumer, NULL);
    
    pthread_join(prod, NULL);
    pthread_join(cons, NULL);
    
    return 0;
}
```
ğŸ“Œ **è§£é‡Šï¼š**
- **`while (count == BUFFER_SIZE)`**ï¼šå¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œç”Ÿäº§è€…ç­‰å¾…ã€‚  
- **`pthread_cond_wait(&not_full, &mutex);`**ï¼šè®©ç”Ÿäº§è€…è¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°æ¶ˆè´¹è€…å–å‡ºæ•°æ®ã€‚  
- **`pthread_cond_signal(&not_empty);`**ï¼šå½“ç”Ÿäº§è€…æ”¾å…¥æ•°æ®åï¼Œå”¤é†’æ¶ˆè´¹è€…ã€‚  
- **`pthread_cond_broadcast(&cond_var);`**ï¼šç¡®ä¿æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹éƒ½èƒ½è¢«å”¤é†’ã€‚  

---

### **4. å…³é”®ç‚¹æ€»ç»“**
| **åŠŸèƒ½**            | **å—ä¿æŠ¤å‘½ä»¤** | **POSIX çº¿ç¨‹å®ç°** |
|--------------------|-------------|----------------|
| **ä¿æŠ¤æ¡ä»¶æ£€æŸ¥**    | `when (guard) {}` | `while (!guard) pthread_cond_wait();` |
| **ç­‰å¾…æ¡ä»¶æ»¡è¶³**    | **è‡ªåŠ¨é˜»å¡çº¿ç¨‹** | `pthread_cond_wait(&cond_var, &mutex);` |
| **ä¿®æ”¹æ¡ä»¶å¹¶é€šçŸ¥**  | **æ— é¡»é¢å¤–æ“ä½œ** | `pthread_cond_broadcast(&cond_var);` |
| **äº’æ–¥ä¿æŠ¤**        | **é»˜è®¤æ”¯æŒ** | `pthread_mutex_lock(&mutex);` |

---

### **5. ä¸ºä»€ä¹ˆ `pthread_cond_wait` éœ€è¦ `while` è€Œä¸æ˜¯ `if`ï¼Ÿ**
#### **é—®é¢˜ï¼šä¸ºä»€ä¹ˆ `while (!guard)` è€Œä¸æ˜¯ `if (!guard)`ï¼Ÿ**
- `pthread_cond_wait(&cond_var, &mutex);` **å¯èƒ½ä¼šè¢«æ„å¤–å”¤é†’ï¼ˆspurious wakeupï¼‰**ã€‚  
- å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½åœ¨ä¿®æ”¹ `guard` åï¼Œ**å¯¼è‡´ `guard` å†æ¬¡å˜ä¸º `false`**ã€‚  
- `while` ç¡®ä¿**çº¿ç¨‹åœ¨è¢«å”¤é†’åå¿…é¡»é‡æ–°æ£€æŸ¥ `guard` æ˜¯å¦çœŸçš„ä¸ºçœŸ**ã€‚  

ğŸ“Œ **ç¤ºä¾‹ï¼šé”™è¯¯çš„ `if (!guard)` ä»£ç **
```cpp
pthread_mutex_lock(&mutex);
if (!guard)
    pthread_cond_wait(&cond_var, &mutex);  
// è¿™é‡Œ guard å¯èƒ½å˜æˆ falseï¼Œä½†çº¿ç¨‹ä»ç„¶ç»§ç»­æ‰§è¡Œï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯
```
ğŸ“Œ **æ­£ç¡®çš„ `while (!guard)` ä»£ç **
```cpp
pthread_mutex_lock(&mutex);
while (!guard)
    pthread_cond_wait(&cond_var, &mutex);  
// è¿™é‡Œç¡®ä¿ guard çœŸçš„ä¸ºçœŸåæ‰æ‰§è¡Œåç»­ä»£ç 
```

---

### **6. ç»“è®º**
1. **å—ä¿æŠ¤å‘½ä»¤** æ˜¯ä¸€ç§æ¦‚å¿µæ¨¡å‹ï¼ŒPOSIX çº¿ç¨‹åº“ç”¨ **æ¡ä»¶å˜é‡ï¼ˆCondition Variablesï¼‰+ äº’æ–¥é”ï¼ˆMutexï¼‰** å®ç°å®ƒã€‚  
2. **`pthread_cond_wait()`** è®©çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°æŸä¸ªæ¡ä»¶æˆç«‹ã€‚  
3. **`pthread_cond_broadcast()`** å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œ**`pthread_cond_signal()`** ä»…å”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚  
4. **ä½¿ç”¨ `while` è€Œä¸æ˜¯ `if`**ï¼Œä»¥é˜²æ­¢**æ„å¤–å”¤é†’ï¼ˆspurious wakeupï¼‰**å¯¼è‡´çš„é”™è¯¯æ‰§è¡Œã€‚  

ğŸš€ **POSIX çº¿ç¨‹åŒæ­¥æ˜¯ä¸€ç§å¼ºå¤§çš„å·¥å…·ï¼Œå®ƒæä¾›äº†çµæ´»çš„æ–¹å¼æ¥å®ç°å¤æ‚çš„å¤šçº¿ç¨‹åŒæ­¥é€»è¾‘ï¼**

---

## **çº¿ç¨‹å®‰å…¨ï¼ˆThread Safetyï¼‰**
---

### **1. å¼•è¨€**
è®¸å¤š Unix åº“å‡½æ•°æ˜¯åœ¨ **å¤šçº¿ç¨‹ç¼–ç¨‹æ™®åŠä¹‹å‰** è®¾è®¡çš„ï¼Œå› æ­¤å®ƒä»¬ä½¿ç”¨çš„ä¸€äº›ç¼–ç¨‹æ¨¡å¼ **ä¸å¤šçº¿ç¨‹ç¨‹åºä¸å…¼å®¹**ã€‚

å…¶ä¸­ä¸€ä¸ªå…¸å‹é—®é¢˜æ˜¯**å…¨å±€å˜é‡ `errno`** çš„ä½¿ç”¨ï¼Œå®ƒç”¨äºå­˜å‚¨ç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ç ã€‚ä½†åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œ**æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ª `errno` å˜é‡**ï¼Œå½“å¤šä¸ªçº¿ç¨‹åŒæ—¶å‘ç”Ÿé”™è¯¯æ—¶ï¼Œ`errno` çš„å€¼ä¼šè¢«è¦†ç›–ï¼Œå¯¼è‡´é”™è¯¯å¤„ç†æ··ä¹±ã€‚

---

### **2. å¤šçº¿ç¨‹ä¸­çš„ `errno` é—®é¢˜**
#### **2.1 é—®é¢˜ï¼šå…¨å±€ `errno` å˜é‡**
```cpp
int IOfunc() {
   extern int errno;
   ...
   if (write(fd, buffer, size) == -1) {  
       if (errno == EIO)  // æ£€æŸ¥é”™è¯¯ç   
         fprintf(stderr, "IO problems ...\n");
       ...
       return (0);
   }
   ...
}
```
ğŸ“Œ **é—®é¢˜ï¼š**  
- `errno` æ˜¯ **å…¨å±€å˜é‡**ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«å®ƒã€‚
- å¦‚æœ**ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å‘ç”Ÿé”™è¯¯**ï¼Œå®ƒä»¬ä¼š**è¦†ç›–å½¼æ­¤çš„ `errno` å€¼**ï¼Œå¯¼è‡´é”™è¯¯å¤„ç†é”™è¯¯ã€‚

#### **2.2 è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTSDï¼‰**
POSIX æä¾›äº†**çº¿ç¨‹ç‰¹å®šæ•°æ®ï¼ˆThread-Specific Dataï¼ŒTSDï¼‰**ï¼Œç”¨äºåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­**å­˜å‚¨ç§æœ‰å˜é‡**ã€‚

```cpp
#define errno pthread_getspecific(errno_key)
```
ğŸ“Œ **è§£é‡Šï¼š**
- `pthread_getspecific(errno_key)` è®©æ¯ä¸ªçº¿ç¨‹è®¿é—®å®ƒ**è‡ªå·±**çš„ `errno`ã€‚
- `pthread_setspecific(errno_key, err);` **å­˜å‚¨é”™è¯¯ç ** åˆ°çº¿ç¨‹å±€éƒ¨å­˜å‚¨ä¸­ã€‚

---

### **3. POSIX çº¿ç¨‹ç‰¹å®šæ•°æ®ï¼ˆTSDï¼‰**
| **å‡½æ•°** | **æè¿°** |
|----------|---------|
| `pthread_key_create(pthread_key_t *key, void (*destructor)(void *))` | åˆ›å»ºçº¿ç¨‹ç‰¹å®šå­˜å‚¨çš„é”®ã€‚ |
| `pthread_setspecific(pthread_key_t key, const void *value)` | è®¾ç½®å½“å‰çº¿ç¨‹çš„å€¼ã€‚ |
| `pthread_getspecific(pthread_key_t key)` | è·å–å½“å‰çº¿ç¨‹å­˜å‚¨çš„å€¼ã€‚ |
| `pthread_key_delete(pthread_key_t key)` | åˆ é™¤é”®ï¼ˆä¸å½±å“çº¿ç¨‹æœ¬åœ°æ•°æ®ï¼‰ã€‚ |

---

### **4. ç¤ºä¾‹ï¼šè®© `errno` çº¿ç¨‹å®‰å…¨**
```cpp
pthread_key_t errno_key;

void startup() {
   pthread_key_create(&errno_key, NULL);
}

int write(...) {
  int err = syscallTrap(WRITE, ...);
  if (err)
    pthread_setspecific(errno_key, (void *)(long)err);
}

#define errno ((int)(long)pthread_getspecific(errno_key))
```

---

### **5. ç¤ºä¾‹ï¼šçº¿ç¨‹å®‰å…¨çš„å‡­æ®å­˜å‚¨**
```cpp
pthread_key_create(&cred_key, free_cred);
```
ğŸ“Œ **ä¿è¯çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨é‡Šæ”¾å­˜å‚¨çš„å‡­æ®ï¼**

---

### **6. æ€»ç»“**
ğŸš€ **POSIX çº¿ç¨‹ç‰¹å®šæ•°æ®æ˜¯ç¼–å†™çº¿ç¨‹å®‰å…¨ä»£ç çš„å¼ºå¤§å·¥å…·ï¼**

---

## **çº¿ç¨‹æ‰§è¡Œçš„åå·®ï¼ˆDeviationsï¼‰**
---

### **1. å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œåå·®**
é€šå¸¸æƒ…å†µä¸‹ï¼Œçº¿ç¨‹çš„æ‰§è¡Œåªä¼šå—åˆ°**åŒæ­¥æœºåˆ¶**çš„å½±å“ï¼ˆå¦‚äº’æ–¥é”ã€æ¡ä»¶å˜é‡ï¼‰ã€‚ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰æ›´å¼ºçš„æ§åˆ¶èƒ½åŠ›ï¼Œä¾‹å¦‚**å¼ºåˆ¶ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹**æˆ–è®©å®ƒæ”¹å˜æ‰§è¡Œæµç¨‹ã€‚

- **POSIX æ–¹æ¡ˆ**ï¼šæä¾›**çº¿ç¨‹å–æ¶ˆæœºåˆ¶**ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å¦ä¸€ä¸ªçº¿ç¨‹å¹²å‡€åœ°ç»ˆæ­¢ã€‚
- **Windows æ–¹æ¡ˆ**ï¼š**æ²¡æœ‰å†…ç½®çº¿ç¨‹å–æ¶ˆæœºåˆ¶**ï¼Œä½†å¯ä»¥é€šè¿‡å…¶ä»–æ–¹æ³•å®ç°ç±»ä¼¼åŠŸèƒ½ã€‚

---

### **2. Unix ä¿¡å·ï¼šä¼ ç»Ÿçš„ä¸­æ–­æœºåˆ¶**
Unix é€šè¿‡**ä¿¡å·ï¼ˆSignalï¼‰**æœºåˆ¶æ¥å¤„ç†ç³»ç»Ÿä¸­æ–­ï¼Œä¾‹å¦‚ï¼š

#### **ä½•æ—¶è§¦å‘ä¿¡å·ï¼Ÿ**
- **ç”¨æˆ·è¾“å…¥**ï¼šæŒ‰ **Ctrl-C** å‘é€ `SIGINT` ä¿¡å·ã€‚
- **å®šæ—¶å™¨**ï¼šæ—¶é—´åˆ°è¾¾åè§¦å‘ä¿¡å·ã€‚
- **è¿›ç¨‹é—´é€šä¿¡**ï¼šä½¿ç”¨ `kill()` å‘é€ä¿¡å·ã€‚
- **å¼‚å¸¸**ï¼šé™¤é›¶é”™è¯¯æˆ–è®¿é—®éæ³•å†…å­˜ã€‚

#### **ç¤ºä¾‹ï¼šå¤„ç† SIGINT ä¿¡å·**
```c
#include <signal.h>
#include <stdlib.h>
#include <stdio.h>

void handler(int sig) {
   printf("ç¨‹åºç»ˆæ­¢å‰æ¸…ç†èµ„æº...\n");
   exit(1);
}

int main() {
   signal(SIGINT, handler);  // ç»‘å®šä¿¡å·å¤„ç†ç¨‹åº
   while (1) {
      // è¿è¡Œé•¿æ—¶é—´ä»£ç 
   }
   return 0;
}
```
ğŸ“Œ **è¯´æ˜**ï¼š
- ç”¨æˆ·æŒ‰ **Ctrl-C** è§¦å‘ `SIGINT`ã€‚
- `handler()` **æ‰§è¡Œæ¸…ç†ä»»åŠ¡**ï¼Œç„¶åé€€å‡ºç¨‹åºã€‚
- å¦‚æœæ²¡æœ‰ `handler()`ï¼ŒOS ç›´æ¥ç»ˆæ­¢è¿›ç¨‹ã€‚

---

### **3. å¤šçº¿ç¨‹ä¿¡å·å¤„ç†çš„é—®é¢˜**
åœ¨**å•çº¿ç¨‹ç¨‹åº**ä¸­ï¼Œä¿¡å·å¤„ç†é€šå¸¸æ²¡é—®é¢˜ã€‚ä½†åœ¨**å¤šçº¿ç¨‹**ç¨‹åºä¸­ï¼Œä¼šäº§ç”Ÿä»¥ä¸‹é—®é¢˜ï¼š
1. **å“ªä¸ªçº¿ç¨‹æ¥æ”¶ä¿¡å·ï¼Ÿ**  
   - **ä¿¡å·æ˜¯å‘é€ç»™è¿›ç¨‹çš„**ï¼Œä½†**çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€éƒ¨åˆ†**ã€‚
   - POSIX è§„åˆ™ï¼šä¿¡å·ä¼šä¼ é€’ç»™**æœªå±è”½è¯¥ä¿¡å·çš„éšæœºçº¿ç¨‹**ã€‚

2. **ä¿¡å·å¤„ç†å‡½æ•°å¯èƒ½ä¿®æ”¹å…±äº«æ•°æ®**  
   - å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªå˜é‡ï¼Œå¯¼è‡´**æ•°æ®ç«äº‰**ã€‚
   - **ä¸èƒ½ä½¿ç”¨äº’æ–¥é”**ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æ­»é”ã€‚

---

### **4. è§£å†³æ–¹æ¡ˆ**
#### **æ–¹æ¡ˆ 1ï¼šé˜»å¡ä¿¡å·**
ä½¿ç”¨ `sigprocmask()` **åœ¨å…³é”®ä»£ç ä¸­å±è”½ä¿¡å·**ï¼š
```c
sigset_t set;
sigemptyset(&set);
sigaddset(&set, SIGINT);
sigprocmask(SIG_BLOCK, &set, NULL);  // é˜»å¡ SIGINT
// å…³é”®æ“ä½œ
sigprocmask(SIG_UNBLOCK, &set, NULL);  // è§£é™¤å±è”½
```
âš  **ç¼ºç‚¹**ï¼š
- éœ€è¦é¢‘ç¹è°ƒç”¨ **ç³»ç»Ÿè°ƒç”¨**ï¼Œå¯èƒ½å½±å“æ€§èƒ½ã€‚

---

#### **æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¸“ç”¨çš„ä¿¡å·å¤„ç†çº¿ç¨‹**
```c
void *monitor(void *arg) {
    int sig;
    while (1) {
        sigwait(&set, &sig);
        pthread_mutex_lock(&mut);
        printf("å¤„ç†ä¿¡å·: %d\n", sig);
        pthread_mutex_unlock(&mut);
    }
    return NULL;
}
```
ğŸ“Œ **ä¼˜åŠ¿**ï¼š
âœ… **ä¸å½±å“ä¸»çº¿ç¨‹æ‰§è¡Œ**ã€‚  
âœ… **å®‰å…¨è®¿é—®å…±äº«æ•°æ®**ï¼ˆä½¿ç”¨äº’æ–¥é”ï¼‰ã€‚  
âœ… **é¿å…ä¿¡å·å¤„ç†å¼•å‘çš„ç«æ€æ¡ä»¶**ã€‚  

---
ğŸš€ **ç»“è®ºï¼šä½¿ç”¨ä¸“ç”¨çº¿ç¨‹å¤„ç†ä¿¡å·ï¼Œæ›´åŠ å®‰å…¨å’Œé«˜æ•ˆï¼**

---

## **POSIX çº¿ç¨‹å–æ¶ˆæœºåˆ¶ï¼šå®‰å…¨ç»ˆæ­¢çº¿ç¨‹**

### **1. å¼•è¨€**
åœ¨è®¸å¤šç¨‹åºä¸­ï¼Œ**æ— æ³•ä¸­é€”å–æ¶ˆé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡**ï¼Œå°¤å…¶æ˜¯åœ¨ **å¤šçº¿ç¨‹ç¨‹åº** ä¸­ã€‚æˆ‘ä»¬å¯èƒ½å¸Œæœ›ç»ˆæ­¢æŸä¸ªçº¿ç¨‹ï¼š
- **ç”¨æˆ·è¯·æ±‚é€€å‡º**ï¼ˆä¾‹å¦‚æŒ‰ä¸‹â€œå–æ¶ˆâ€æŒ‰é’®ï¼‰ã€‚
- **ä»»åŠ¡å·²å®Œæˆï¼Œä¸å†éœ€è¦è¯¥çº¿ç¨‹**ã€‚

#### **çº¿ç¨‹ç»ˆæ­¢çš„æ ¸å¿ƒé—®é¢˜**
- **å¼ºåˆ¶ç»ˆæ­¢æ˜¯å±é™©çš„**ï¼šå¯èƒ½å¯¼è‡´**äº’æ–¥é”æœªé‡Šæ”¾**æˆ–**æ•°æ®ç»“æ„æŸå**ã€‚
- **åº”ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾**ï¼šå¦‚å·²åˆ†é…çš„å†…å­˜åº”è¢«é‡Šæ”¾ã€‚
- **ç»ˆæ­¢åº”å‘ç”Ÿåœ¨å®‰å…¨ç‚¹**ï¼Œé¿å…ç ´åå…±äº«æ•°æ®ã€‚

---

### **2. ä¸ºä»€ä¹ˆä¸èƒ½éšæ„ç»ˆæ­¢çº¿ç¨‹ï¼Ÿ**
è€ƒè™‘ä»¥ä¸‹ **åŒå‘é“¾è¡¨æ’å…¥å‡½æ•°**ï¼š
```c
void insert(list_item_t *item) {
  pthread_mutex_lock(&list_mutex);
  item->backward_link = list_head;
  item->forward_link = list_head.forward_link;
  if (list_head.forward_link != 0)
    list_head.forward_link->backward_link = item;
  list_head.forward_link = item;
  pthread_mutex_unlock(&list_mutex);
}
```
ğŸ“Œ **é—®é¢˜**ï¼š
- å¦‚æœåœ¨ **æ‰§è¡Œä¸­é€”ç»ˆæ­¢** çº¿ç¨‹ï¼š
  - **äº’æ–¥é”ï¼ˆmutexï¼‰æœªé‡Šæ”¾**ï¼Œå…¶ä»–çº¿ç¨‹ä¼š**æ°¸è¿œé˜»å¡**ã€‚
  - **é“¾è¡¨å˜å¾—ä¸å®Œæ•´**ï¼Œå¯¼è‡´æ•°æ®æŸåã€‚

âœ… **è§£å†³æ–¹æ¡ˆ**ï¼š
- çº¿ç¨‹ **åªèƒ½åœ¨é¢„å®šä¹‰çš„â€œå®‰å…¨ç‚¹â€ç»ˆæ­¢**ã€‚

---

### **3. POSIX çº¿ç¨‹å–æ¶ˆæœºåˆ¶**
POSIX å…è®¸ **ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚å¦ä¸€ä¸ªçº¿ç¨‹ç»ˆæ­¢**ï¼š
```c
pthread_cancel(thread_id);
```
- **ä¸ä¼šç«‹å³ç»ˆæ­¢**çº¿ç¨‹ï¼Œè€Œæ˜¯**æ ‡è®°**è¯¥çº¿ç¨‹éœ€è¦å–æ¶ˆã€‚
- çº¿ç¨‹æ˜¯å¦ç»ˆæ­¢å–å†³äºå…¶ **å–æ¶ˆçŠ¶æ€ï¼ˆcancel stateï¼‰** å’Œ **å–æ¶ˆç±»å‹ï¼ˆcancel typeï¼‰**ã€‚

#### **å–æ¶ˆçŠ¶æ€**
```c
pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL);  // å…è®¸å–æ¶ˆ
pthread_setcancelstate(PTHREAD_CANCEL_DISABLE, NULL); // ç¦æ­¢å–æ¶ˆ
```
- **å¯ç”¨å–æ¶ˆï¼ˆENABLEï¼‰**ï¼šçº¿ç¨‹å¯ä»¥è¢«ç»ˆæ­¢ã€‚
- **ç¦ç”¨å–æ¶ˆï¼ˆDISABLEï¼‰**ï¼šçº¿ç¨‹å¿½ç•¥å–æ¶ˆè¯·æ±‚ã€‚

#### **å–æ¶ˆç±»å‹**
```c
pthread_setcanceltype(PTHREAD_CANCEL_ASYNCHRONOUS, NULL); // ç«‹å³ç»ˆæ­¢
pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL);     // å»¶è¿Ÿç»ˆæ­¢
```
- **å¼‚æ­¥ï¼ˆASYNCHRONOUSï¼‰**ï¼šçº¿ç¨‹**éšæ—¶å¯èƒ½ç»ˆæ­¢**ï¼ˆä¸å®‰å…¨ï¼‰ã€‚
- **å»¶è¿Ÿï¼ˆDEFERREDï¼‰**ï¼šçº¿ç¨‹**ä»…åœ¨ç‰¹å®šç‚¹ç»ˆæ­¢**ï¼ˆå®‰å…¨ï¼‰ã€‚

---

### **4. ç»“è®º**
âœ… **POSIX å–æ¶ˆæœºåˆ¶ç¡®ä¿çº¿ç¨‹å®‰å…¨ç»ˆæ­¢**ã€‚  
âœ… **å¿…é¡»åœ¨å®‰å…¨ç‚¹è¿›è¡Œå–æ¶ˆ**ï¼Œé¿å…èµ„æºæŸåã€‚  
âœ… **åº”ä½¿ç”¨æ¸…ç†å¤„ç†ç¨‹åºï¼ˆcleanup handlersï¼‰é‡Šæ”¾èµ„æº**ã€‚  
âœ… **C++ çº¿ç¨‹å–æ¶ˆéœ€è¦ç‰¹åˆ«æ³¨æ„å¯¹è±¡ææ„**ã€‚